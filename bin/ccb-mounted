#!/usr/bin/env bash
# ccb-mounted - Check which CCB providers are mounted
# Usage: ccb-mounted [--json|--simple]

set -euo pipefail

PROVIDERS="codex:cask gemini:gask opencode:oask claude:lask droid:dask"
CWD="${1:-$(pwd)}"
FORMAT="${2:---json}"

# Single pgrep to get all online daemons
ONLINE=$(pgrep -af "bin/[cglod]askd$" 2>/dev/null | grep -oE "[cglod]askd" | sort -u || true)

MOUNTED=""
for pair in $PROVIDERS; do
  provider="${pair%%:*}"
  daemon="${pair##*:}"

  # Check session file exists
  if [[ -f "$CWD/.ccb_config/.${provider}-session" ]] || [[ -f "$CWD/.${provider}-session" ]]; then
    # Check daemon is online
    if echo "$ONLINE" | grep -q "^${daemon}d$"; then
      MOUNTED="$MOUNTED $provider"
    fi
  fi
done

MOUNTED=$(echo $MOUNTED | xargs)  # trim

case "$FORMAT" in
  --simple)
    echo "$MOUNTED"
    ;;
  --json|*)
    if [[ -z "$MOUNTED" ]]; then
      echo "{\"cwd\":\"$CWD\",\"mounted\":[]}"
    else
      JSON_ARRAY=$(echo "$MOUNTED" | sed 's/ /","/g;s/^/"/;s/$/"/')
      echo "{\"cwd\":\"$CWD\",\"mounted\":[$JSON_ARRAY]}"
    fi
    ;;
esac
